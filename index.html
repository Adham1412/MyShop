<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyShop - Ishonchli Savdo</title>
    <meta name="google-site-verification" content="FnYRS6mRaeVoYVWcw9hDtrXsYhYawLlp562dtzyA3Wc" />
    <script src="https://cdn.tailwindcss.com"></script>
    google-site-verification: google979aaa67f511ca30.html
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .product-img { height: 220px; object-fit: cover; width: 100%; transition: 0.3s; }
        .product-card:hover .product-img { transform: scale(1.05); }
        .loader { border-top-color: #3b82f6; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* File Upload Styles */
        .file-preview-item { position: relative; width: 60px; height: 60px; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0; }
        .file-preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .file-preview-item .remove-btn { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.5); color: white; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; }
        
        /* Trust Badges */
        .trust-badge { transition: transform 0.3s; }
        .trust-badge:hover { transform: translateY(-5px); }
    </style>
</head>
<body class="text-gray-800 flex flex-col min-h-screen">

    <nav class="glass fixed w-full z-50 shadow-sm top-0 left-0 border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0 flex items-center gap-2 cursor-pointer" onclick="window.scrollTo(0,0)">
                    <div class="w-10 h-10 bg-gradient-to-tr from-blue-600 to-blue-400 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-lg">P</div>
                    <span class="font-bold text-xl tracking-tight text-gray-800">MyShop</span>
                </div>
                <div class="relative cursor-pointer p-2 hover:bg-gray-100 rounded-full transition" onclick="toggleCart()">
                    <i class="fa-solid fa-cart-shopping text-xl text-gray-700"></i>
                    <span id="cart-badge" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/4 -translate-y-1/4 bg-red-500 rounded-full hidden shadow-sm">0</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="pt-28 pb-12 px-4 text-center bg-white">
        <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-4 tracking-tight">Sifat va Ishonch <br> <span class="text-blue-600">Bir makonda</span></h1>
        <p class="text-gray-500 max-w-xl mx-auto text-lg mb-6">100% original mahsulotlar, tezkor yetkazib berish va qulay to'lov tizimi.</p>
        <div class="flex justify-center gap-4 text-sm text-gray-600 font-medium">
            <span class="flex items-center gap-1"><i class="fa-solid fa-shield-halved text-green-500"></i> Kafolatlangan</span>
            <span class="flex items-center gap-1"><i class="fa-solid fa-truck-fast text-blue-500"></i> Tezkor</span>
        </div>
    </div>

    <div class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-20 w-full">
        <div id="loading" class="flex justify-center py-10"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div></div>
        <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
    </div>

    <div class="bg-white py-12 border-t border-gray-100">
        <div class="max-w-7xl mx-auto px-4">
            <h2 class="text-2xl font-bold text-center mb-10">Nega aynan biz?</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                <div class="trust-badge p-6 rounded-2xl bg-blue-50">
                    <div class="w-14 h-14 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                        <i class="fa-solid fa-medal"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-2">Sifat Kafolati</h3>
                    <p class="text-gray-500 text-sm">Bizdagi barcha mahsulotlar tekshirilgan va original.</p>
                </div>
                <div class="trust-badge p-6 rounded-2xl bg-green-50">
                    <div class="w-14 h-14 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                        <i class="fa-solid fa-clock"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-2">Tezkor Yetkazish</h3>
                    <p class="text-gray-500 text-sm">Buyurtmangizni 24 soat ichida yetkazib beramiz.</p>
                </div>
                <div class="trust-badge p-6 rounded-2xl bg-purple-50">
                    <div class="w-14 h-14 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                        <i class="fa-solid fa-headset"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-2">24/7 Qo'llab-quvvatlash</h3>
                    <p class="text-gray-500 text-sm">Savollaringiz bormi? Biz har doim aloqadamiz.</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-900 text-white py-8 mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <h2 class="text-2xl font-bold mb-4">MyShop</h2>
            <p class="text-gray-400 mb-6 text-sm">Eng yaxshi mahsulotlar va xizmatlar.</p>
            <div class="flex justify-center gap-6 mb-6">
                <a href="#" class="text-gray-400 hover:text-white transition"><i class="fa-brands fa-telegram text-2xl"></i></a>
                <a href="#" class="text-gray-400 hover:text-white transition"><i class="fa-brands fa-instagram text-2xl"></i></a>
                <a href="#" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-phone text-2xl"></i></a>
            </div>
            <p class="text-gray-600 text-xs">&copy; 2025 MyShop. Barcha huquqlar himoyalangan.</p>
        </div>
    </footer>

    <div id="cart-sidebar" class="fixed inset-y-0 right-0 w-full md:w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-[60] flex flex-col">
        <div class="p-5 border-b flex justify-between items-center bg-gray-50">
            <h2 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-basket-shopping"></i> Savatcha</h2>
            <button onclick="toggleCart()" class="text-gray-400 hover:text-red-500 text-2xl transition">&times;</button>
        </div>
        
        <div id="cart-items" class="flex-1 overflow-y-auto p-5 space-y-3 bg-gray-50/50">
            <div class="text-center text-gray-400 mt-10 flex flex-col items-center">
                <i class="fa-solid fa-cart-arrow-down text-4xl mb-2 opacity-20"></i>
                <p>Savatcha bo'sh</p>
            </div>
        </div>

        <div class="p-5 border-t bg-white shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
            <div class="flex justify-between text-lg font-bold mb-4">
                <span class="text-gray-600">Jami summa:</span>
                <span id="total-price" class="text-blue-600">0 so'm</span>
            </div>
            <button id="checkout-btn" onclick="openCheckout()" disabled class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-blue-200">
                Rasmiylashtirish <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>
    
    <div id="checkout-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-y-auto max-h-[90vh] animate-fadeIn">
            <div class="sticky top-0 bg-white p-5 border-b flex justify-between items-center z-10">
                <h2 class="text-xl font-bold text-gray-800">Buyurtma berish</h2>
                <button onclick="closeCheckout()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition text-gray-500">&times;</button>
            </div>
            
            <form id="order-form" class="p-6 space-y-5">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ismingiz</label>
                        <input type="text" id="name" required class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition" placeholder="Ism Familiya">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Telefon</label>
                        <input type="tel" id="phone" required class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none font-mono" placeholder="+998 (__) ___-__-__" value="+998 ">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Yetkazib berish manzili</label>
                    <div class="relative">
                        <textarea id="address" rows="2" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 pr-12 focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition resize-none" placeholder="Aniq manzil yoki mo'ljal..."></textarea>
                        <button type="button" onclick="getLocation()" class="absolute right-2 top-2 bottom-2 w-10 bg-white border border-gray-200 rounded-md text-gray-500 hover:text-blue-600 hover:border-blue-500 transition flex items-center justify-center" title="Joylashuvni aniqlash">
                            <i class="fa-solid fa-crosshairs text-lg"></i>
                        </button>
                    </div>
                    <input type="hidden" id="geo-link">
                    <p id="geo-status" class="text-xs text-green-600 mt-1 hidden font-bold flex items-center gap-1"><i class="fa-solid fa-check-circle"></i> Joylashuv aniqlandi</p>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">To'lov turi</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="cursor-pointer relative">
                            <input type="radio" name="payment" value="cash" checked class="peer sr-only" onchange="togglePaymentInfo()">
                            <div class="p-3 border rounded-xl flex items-center gap-3 hover:bg-gray-50 peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700 transition">
                                <i class="fa-solid fa-money-bill-wave text-xl"></i>
                                <span class="font-bold text-sm">Mahsulotni olgach naqd pul bilan tolash</span>
                            </div>
                        </label>
                        <label class="cursor-pointer relative">
                            <input type="radio" name="payment" value="card" class="peer sr-only" onchange="togglePaymentInfo()">
                            <div class="p-3 border rounded-xl flex items-center gap-3 hover:bg-gray-50 peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700 transition">
                                <i class="fa-regular fa-credit-card text-xl"></i>
                                <span class="font-bold text-sm">Karta orqali</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div id="card-info" class="hidden bg-slate-50 p-4 rounded-xl border border-slate-200 animate-fadeIn">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-bold text-gray-500">ADMIN KARTA RAQAMIGA TO'LANG VA SIZGA MAHSULOT JO'NATILADI<br> Ochilov Adham</span>
                        <button type="button" onclick="copyCard()" class="text-blue-600 text-xs font-bold hover:underline">Nusxa olish</button>
                    </div>
                    <div class="bg-white p-3 rounded-lg border border-gray-200 font-mono text-center text-lg font-bold tracking-widest mb-4 select-all" id="admin-card-display">
                        9860 0000 0000 0000
                    </div>

                    <div class="border-t border-gray-200 pt-3">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Chek rasmi yoki PDF (Bir nechta bo'lsa ham)</label>
                        
                        <div class="relative">
                            <input type="file" id="payment-files" multiple accept="image/*,application/pdf" class="hidden" onchange="handleFiles(this)">
                            <label for="payment-files" class="flex items-center justify-center w-full p-4 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition gap-2 text-gray-500">
                                <i class="fa-solid fa-cloud-arrow-up text-xl"></i>
                                <span class="text-sm font-medium">Rasm yoki PDF yuklash</span>
                            </label>
                        </div>

                        <div id="file-previews" class="flex flex-wrap gap-2 mt-3"></div>
                        <p id="file-error" class="text-red-500 text-xs mt-1 hidden font-bold">To'lov chekini yuklash majburiy!</p>
                    </div>
                </div>

                <div class="pt-2">
                    <button type="submit" id="submit-btn" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-green-700 shadow-lg shadow-green-200 transition flex justify-center items-center gap-2">
                        <span>Buyurtma berish</span>
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                    <p class="text-center text-xs text-gray-400 mt-3"><i class="fa-solid fa-lock"></i> Ma'lumotlaringiz xavfsizligi kafolatlangan</p>
                </div>
            </form>
        </div>
    </div>

    <div id="overlay" onclick="toggleCart()" class="fixed inset-0 bg-black/20 backdrop-blur-[2px] z-50 hidden"></div>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- SOZLAMALAR ---
        const ADMIN_CARD_NUMBER = "9860 3501 4588 2543"; 
        const TG_BOT_TOKEN = "8399989077:AAGjnF1-MYvE06jQ9Bu6WOr9cMoDNzH21Dc";
        const ADMIN_CHAT_ID = "6481290484"; 

        const firebaseConfig = {
            apiKey: "AIzaSyBjl3OaBoh1LfOUtyH01AIbaS2_jS-hleY",
            authDomain: "myshoppro-56ba3.firebaseapp.com",
            databaseURL: "https://myshoppro-56ba3-default-rtdb.firebaseio.com",
            projectId: "myshoppro-56ba3",
            storageBucket: "myshoppro-56ba3.appspot.com",
            messagingSenderId: "279367818408",
            appId: "1:279367818408:web:265aba3874e0cf026f769d",
            measurementId: "G-PK3K32S12H"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allProducts = [];
        let cart = [];
        let selectedFiles = []; // Fayllarni saqlash uchun massiv

        const productsGrid = document.getElementById('products-grid');
        const loading = document.getElementById('loading');
        const cartSidebar = document.getElementById('cart-sidebar');
        const overlay = document.getElementById('overlay');
        const checkoutModal = document.getElementById('checkout-modal');
        const phoneInput = document.getElementById('phone');
        
        document.getElementById('admin-card-display').innerText = ADMIN_CARD_NUMBER;

        // Firebase-dan mahsulotlarni o'qish
        const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            allProducts = [];
            productsGrid.innerHTML = '';
            loading.style.display = 'none';

            if(snapshot.empty) {
                productsGrid.innerHTML = '<div class="col-span-full text-center py-20 text-gray-500">Mahsulotlar hozircha yo\'q</div>';
                return;
            }

            snapshot.forEach(doc => {
                const prod = doc.data();
                prod.id = doc.id;
                allProducts.push(prod);
                const imgUrl = (prod.images && prod.images.length > 0) ? prod.images[0] : 'https://via.placeholder.com/300?text=Rasm';

                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl shadow-sm hover:shadow-xl border border-gray-100 overflow-hidden product-card group relative flex flex-col h-full transition-all duration-300";
                card.innerHTML = `
                    <div class="relative overflow-hidden h-56 bg-gray-100">
                        <img src="${imgUrl}" alt="${prod.name}" class="product-img h-full w-full object-cover">
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition duration-300"></div>
                    </div>
                    <div class="p-5 flex flex-col flex-1">
                        <h3 class="font-bold text-lg text-gray-900 mb-1 leading-tight">${prod.name}</h3>
                        <p class="text-gray-500 text-sm mb-4 line-clamp-2 flex-1">${prod.description || 'Ta‚Äôrif yo‚Äòq'}</p>
                        <div class="flex justify-between items-center mt-auto pt-4 border-t border-gray-100">
                            <span class="text-blue-600 font-bold text-lg">${Number(prod.price).toLocaleString()} so'm</span>
                            <button onclick="addToCart('${prod.id}')" class="bg-blue-600 text-white w-10 h-10 rounded-xl flex items-center justify-center shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>
                `;
                productsGrid.appendChild(card);
            });
        });

        // Telefon raqam maskasi
        phoneInput.addEventListener('input', function (e) {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,2})(\d{0,3})(\d{0,2})(\d{0,2})/);
            e.target.value = !x[2] ? "+998 " : "+998 (" + x[2] + ") " + (x[3] ? x[3] : "") + (x[4] ? "-" + x[4] : "") + (x[5] ? "-" + x[5] : "");
        });

        // --- YANGILANGAN GPS FUNKSIYASI ---
        window.getLocation = function() {
            const btn = document.querySelector('button[onclick="getLocation()"]');
            const icon = btn.querySelector('i');
            const status = document.getElementById('geo-status');
            const linkInput = document.getElementById('geo-link');
            const addressInput = document.getElementById('address');

            if (navigator.geolocation) {
                icon.className = "fa-solid fa-spinner fa-spin";
                
                const options = {
                    enableHighAccuracy: true, // Yuqori aniqlik
                    timeout: 10000,
                    maximumAge: 0
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const long = position.coords.longitude;
                        // To'g'ri formatdagi Google Maps havolasi
                        const mapLink = `https://www.google.com/maps?q=${lat},${long}`;
                        
                        linkInput.value = mapLink;
                        status.classList.remove('hidden');
                        
                        // Iconni qaytarish
                        icon.className = "fa-solid fa-check text-green-600";
                        btn.classList.add('border-green-500', 'bg-green-50');

                        if(addressInput.value === "") {
                            addressInput.value = "üìç Joylashuv GPS orqali belgilandi";
                        }
                    },
                    (error) => {
                        icon.className = "fa-solid fa-crosshairs";
                        alert("Joylashuvni aniqlab bo'lmadi. Iltimos, telefon sozlamalarida GPS yoniqligini tekshiring.");
                    },
                    options
                );
            } else {
                alert("Brauzeringiz GPS ni qo'llab-quvvatlamaydi.");
            }
        };

        // --- FAYLLARNI QAYTA ISHLASH (MULTI-UPLOAD & PREVIEW) ---
        window.handleFiles = function(input) {
            const previewContainer = document.getElementById('file-previews');
            const files = Array.from(input.files);
            
            files.forEach(file => {
                selectedFiles.push(file); // Massivga qo'shish

                const div = document.createElement('div');
                div.className = 'file-preview-item bg-gray-100 flex items-center justify-center relative';
                
                // O'chirish tugmasi
                const removeBtn = document.createElement('div');
                removeBtn.className = 'remove-btn';
                removeBtn.innerHTML = '<i class="fa-solid fa-times"></i>';
                removeBtn.onclick = () => {
                    const idx = selectedFiles.indexOf(file);
                    if (idx > -1) selectedFiles.splice(idx, 1);
                    div.remove();
                };
                div.appendChild(removeBtn);

                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    div.appendChild(img);
                } else {
                    div.innerHTML += `<div class="text-xs text-center p-1 break-all text-gray-500"><i class="fa-solid fa-file-pdf text-red-500 mb-1"></i><br>${file.name.substring(0,8)}...</div>`;
                    div.appendChild(removeBtn);
                }
                
                previewContainer.appendChild(div);
            });
            input.value = ''; // Inputni tozalash, shunda yana fayl qo'shish mumkin
        };

        window.toggleCart = function() {
            if (cartSidebar.classList.contains('translate-x-full')) {
                cartSidebar.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            } else {
                cartSidebar.classList.add('translate-x-full');
                overlay.classList.add('hidden');
                document.body.style.overflow = '';
            }
        };

        window.addToCart = function(id) {
            const product = allProducts.find(p => p.id === id);
            if(product) {
                cart.push(product);
                updateCartUI();
                Toastify({ text: "Savatga qo'shildi", duration: 2000, gravity: "bottom", position: "center", style: { background: "#2563EB", borderRadius: "10px" } }).showToast();
            }
        };

        window.removeFromCart = function(index) {
            cart.splice(index, 1);
            updateCartUI();
        };

        function updateCartUI() {
            const container = document.getElementById('cart-items');
            const badge = document.getElementById('cart-badge');
            const totalEl = document.getElementById('total-price');
            const btn = document.getElementById('checkout-btn');

            container.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 mt-10 flex flex-col items-center">
                        <i class="fa-solid fa-cart-arrow-down text-4xl mb-2 opacity-20"></i>
                        <p>Savatcha bo'sh</p>
                    </div>`;
                badge.classList.add('hidden');
            } else {
                badge.innerText = cart.length;
                badge.classList.remove('hidden');
                cart.forEach((item, index) => {
                    total += Number(item.price);
                    container.innerHTML += `
                        <div class="flex items-center gap-3 bg-white p-3 rounded-xl shadow-sm border border-gray-100 relative group">
                            <img src="${item.images ? item.images[0] : ''}" class="w-14 h-14 object-cover rounded-lg bg-gray-100">
                            <div class="flex-1 min-w-0">
                                <h4 class="text-sm font-bold truncate text-gray-800">${item.name}</h4>
                                <p class="text-xs text-blue-600 font-bold mt-1">${Number(item.price).toLocaleString()} so'm</p>
                            </div>
                            <button onclick="removeFromCart(${index})" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition"><i class="fa-solid fa-trash-can"></i></button>
                        </div>`;
                });
            }
            totalEl.innerText = total.toLocaleString() + " so'm";
            btn.disabled = total === 0;
        }

        window.openCheckout = function() {
            checkoutModal.classList.remove('hidden');
            toggleCart();
        };

        window.closeCheckout = function() {
            checkoutModal.classList.add('hidden');
        };

        window.togglePaymentInfo = function() {
            const isCard = document.querySelector('input[name="payment"]:checked').value === 'card';
            const cardInfo = document.getElementById('card-info');
            if (isCard) {
                cardInfo.classList.remove('hidden');
            } else {
                cardInfo.classList.add('hidden');
            }
        };

        window.copyCard = function() {
            navigator.clipboard.writeText(ADMIN_CARD_NUMBER);
            Toastify({ text: "Karta raqam nusxalandi", duration: 2000, style: { background: "#10B981", borderRadius: "8px" } }).showToast();
        };

        // --- BUYURTMA YUBORISH ---
        document.getElementById('order-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validatsiya
            const phone = document.getElementById('phone').value;
            if (phone.length < 19) {
                alert("Telefon raqamni to'liq kiriting!");
                return;
            }

            const paymentType = document.querySelector('input[name="payment"]:checked').value;
            
            // Agar karta bo'lsa, fayl borligini tekshirish
            if (paymentType === 'card' && selectedFiles.length === 0) {
                document.getElementById('file-error').classList.remove('hidden');
                return;
            } else {
                document.getElementById('file-error').classList.add('hidden');
            }

            // Button holatini o'zgartirish
            const btn = document.getElementById('submit-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Yuborilmoqda...';

            // Ma'lumotlarni yig'ish
            const name = document.getElementById('name').value;
            const address = document.getElementById('address').value;
            const geoLink = document.getElementById('geo-link').value;
            const paymentText = paymentType === 'card' ? "üí≥ Karta (Chek ilova qilindi)" : "üíµ Naqd pul";

            let msg = `üî• <b>Yangi Buyurtma!</b>\n\n`;
            msg += `üë§ <b>Mijoz:</b> ${name}\n`;
            msg += `üìû <b>Tel:</b> ${phone}\n`;
            msg += `üìç <b>Manzil:</b> ${address}\n`;
            if(geoLink) msg += `üó∫ <b>GPS:</b> <a href="${geoLink}">Xaritada ko'rish</a>\n`;
            msg += `\nüí∞ <b>To'lov:</b> ${paymentText}\n`;
            msg += `üõí <b>Mahsulotlar:</b>\n`;
            
            let total = 0;
            cart.forEach(c => {
                msg += `‚ûñ ${c.name} (${Number(c.price).toLocaleString()})\n`;
                total += Number(c.price);
            });
            msg += `\nüíé <b>JAMI: ${total.toLocaleString()} so'm</b>`;

            try {
                // 1. Matnni yuborish
                await fetch(`https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chat_id: ADMIN_CHAT_ID,
                        text: msg,
                        parse_mode: 'HTML',
                        disable_web_page_preview: true
                    })
                });

                // 2. Agar fayllar bo'lsa, ularni ketma-ket yuborish
                if (selectedFiles.length > 0) {
                    for (const file of selectedFiles) {
                        const formData = new FormData();
                        formData.append('chat_id', ADMIN_CHAT_ID);
                        
                        // Fayl turiga qarab metodni tanlash
                        const method = file.type === 'application/pdf' ? 'sendDocument' : 'sendPhoto';
                        const fileKey = file.type === 'application/pdf' ? 'document' : 'photo';
                        
                        formData.append(fileKey, file);
                        
                        await fetch(`https://api.telegram.org/bot${TG_BOT_TOKEN}/${method}`, {
                            method: 'POST',
                            body: formData
                        });
                    }
                }

                // Muvaffaqiyatli yakunlash
                Toastify({ text: "Buyurtmangiz qabul qilindi! Tez orada aloqaga chiqamiz.", duration: 5000, close: true, style: { background: "#10B981", borderRadius: "10px" } }).showToast();
                
                // Tozalash
                cart = [];
                selectedFiles = [];
                updateCartUI();
                closeCheckout();
                document.getElementById('order-form').reset();
                document.getElementById('file-previews').innerHTML = '';
                document.getElementById('geo-status').classList.add('hidden');
                togglePaymentInfo();

            } catch (error) {
                console.error(error);
                alert("Xatolik yuz berdi! Internetni tekshiring.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });
    </script>
</body>

</html>

